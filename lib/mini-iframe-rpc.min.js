!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("mini-iframe-rpc",[],t):"object"==typeof exports?exports["mini-iframe-rpc"]=t():e["mini-iframe-rpc"]=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){e.exports=n(1)},function(e,t,n){"use strict";n.r(t);var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function i(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function o(e,t,n,r){return new(n||(n=Promise))(function(i,o){function a(e){try{c(r.next(e))}catch(e){o(e)}}function s(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(a,s)}c((r=r.apply(e,t||[])).next())})}function a(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=(i=a.trys).length>0&&i[i.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var s=function(e){function t(n,r){var i=this.constructor,o=e.call(this,n)||this;return o.timestamp=+new Date,r&&Object.assign(o,r),Object.setPrototypeOf(o,i.prototype),o.name=t.name,o}return i(t,e),t}(Error);function c(e){var t=e.message,n=e.name,r=e.stack;return Object.assign({message:t,stack:r,name:n},e)}var u=function(e){return"string"==typeof e?e:""+e.message},l=function(e){function t(n){var r=e.call(this,u(n))||this;return r.cause="string"==typeof n?n:c(n),r.name=t.name,r}return i(t,e),t}(s),f=function(e){function t(n){var r=e.call(this,n.cause)||this;return r.name=t.name,r}return i(t,e),t}(l),p=function(e){return null!=e&&(e instanceof Error||e instanceof DOMException||"DataCloneError"===e.name||e.message&&"string"==typeof e.message&&e.stack&&"string"==typeof e.stack)},h=function(e,t,n){var r="Error invoking remote procedure '"+e+"'.";if(p(t)?r+=" "+t.name+": "+t.message+".":t&&(r+=" Reason: "+t.toString()),n&&n.length>0){var i=n.length>1?"s":"";r+=" "+n.length+" additional rejection"+i+" from retried attempt"+i+"."}return r},d=function(e){function t(n,r,i){var o=e.call(this,h(n,r,i))||this;return o.name=t.name,o.procedureName=n,o.cause=r,o.previousRejectReasons=i,o}return i(t,e),t}(s),m=function(e){function t(n){var r=e.call(this,"Remote procedure '"+n.procedureName+"' not registered in remote RPC instance.")||this;return r.procedureName="unknown",n.procedureName&&(r.procedureName=n.procedureName),r.name=t.name,r}return i(t,e),t}(l),g=function(e){function t(n){var r=e.call(this,n.cause)||this;return r.name=t.name,r}return i(t,e),t}(l),y=function(e){function t(n){var r=e.call(this,"Timeout after "+n.timeoutMilliSeconds+" ms.",n)||this;return r.timeoutMilliSeconds=0,r.name=t.name,r}return i(t,e),t}(s),v=[m,f,g].reduce(function(e,t){return e[t.name]=t,e},{}),b=200,w={capacity:b},C=function(){function e(e){this.ids=[],this.results={},this.config=Object.assign({},w,e||{})}return e.prototype.hasCachedResult=function(e){return this.results.hasOwnProperty(e)},e.prototype.getCachedResult=function(e){return this.results[e]},e.prototype.setCachedResult=function(e,t){this.hasCachedResult(e)&&(this.ids=this.ids.filter(function(t){return t!==e})),this.ids.unshift(e),this.results[e]=t,this.config.capacity>=0&&this.enforceCapacity()},e.prototype.enforceCapacity=function(){for(var e=this.ids.length;e>this.config.capacity;e--){var t=this.ids.pop(),n=this.results[t];delete this.results[t],this.config.evictionCallback&&this.config.evictionCallback(t,n)}},e}(),R=function(){return"Microsoft Internet Explorer"===navigator.appName||!!navigator.userAgent.match(/Trident|MSIE|rv:11/)},O="mini-iframe-rpc",k={stringifyObjects:R()},j=function(){function e(e,t,n){var r=this;this.recv=function(e){if((!r.config.originWhitelist||r.config.originWhitelist.length<1||r.config.originWhitelist.indexOf(e.origin)>-1)&&e.data){var t=r.readMessageData(e);t&&t.type===O&&t.payload&&r.onReceive(t.payload,e.source,e.origin)}},this.windowRef=e||window,this.onReceive=t,this.config=Object.assign({},k,n||{}),this.windowRef.addEventListener("message",this.recv)}return e.prototype.close=function(){this.windowRef.removeEventListener("message",this.recv)},e.prototype.send=function(e,t){var n=this;return new Promise(function(r,i){var o={type:O,payload:t};e.targetWindow.postMessage(n.config.stringifyObjects?JSON.stringify(o,function(e,t){return void 0===t?null:t}):o,e.targetOrigin||"*"),r()})},e.prototype.readMessageData=function(e){if("string"==typeof e.data&&JSON&&R())try{return JSON.parse(e.data)}catch(e){return null}return e.data},e}();n.d(t,"MiniIframeRPC",function(){return x}),n.d(t,"ResultCache",function(){return C});var P={timeout:100,retryLimit:2,retryAllFailures:!1},x=function(){function e(e){var t=this;this.callbacks={},this.registeredProcedures={},this.recv=function(e,n,r){t.internalEventCallback("onReceive",e,n,r),"method"in e?t.handleRequest(e,n,r):t.handleResponse(e)},this.config={windowRef:e&&e.windowRef||window,originWhitelist:e&&e.originWhitelist||[],defaultInvocationOptions:Object.assign({},P,e&&e.defaultInvocationOptions||{}),eventCallbacks:e&&e.eventCallbacks||{},resultCacheCapacity:e&&"number"==typeof e.resultCacheCapacity?e.resultCacheCapacity:b},this.resultCache=new C({capacity:this.config.resultCacheCapacity,evictionCallback:function(e,n){t.internalEventCallback("onResultCacheEviction",e,n)}}),this.transport=new j(this.config.windowRef,this.recv,{originWhitelist:this.config.originWhitelist})}return e.prototype.register=function(e,t){this.internalEventCallback("onRegister",e,t),t?this.registeredProcedures[e]=t:delete this.registeredProcedures[e]},e.prototype.invoke=function(e,t,n,r,i){var o=Object.assign({},this.config.defaultInvocationOptions,i||{}),a={id:this.getNextCallId(),method:n,params:r||[]};return this.requestWithRetry(e,t,a,o)},e.prototype.close=function(){this.internalEventCallback("onClose"),this.transport.close()},e.prototype.requestWithRetry=function(e,t,n,r){var i=this,s=0,c=0,u=function(){},l=function(){},f=!1,p=[],h=function(e){f=!0,u(e)},m=function(e){var t;c+=1,f||c!==s||(t=e,!(r.timeout<=0||r.retryLimit<1)&&(r.retryAllFailures||t instanceof y)&&s<r.retryLimit+1?(i.internalEventCallback("onRequestRetry",e,p,n),p.push(e),g()):(f=!0,l(new d(n.method,e,p))))},g=function(){s+=1;var c=o(i,void 0,void 0,function(){var r=this;return a(this,function(i){return[2,this.sendMessage(e,t,n).then(function(){return new Promise(function(e,t){r.callbacks[n.id]={resolve:e,reject:t}})})]})});r.timeout>0&&(c=i.timeboxPromise(c,r.timeout)),c.then(h,m)},v=new Promise(function(e,t){u=e,l=t});return g(),v},e.prototype.internalEventCallback=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=this.config.eventCallbacks[e];r&&r.apply(this,t)},e.prototype.timeboxPromise=function(e,t){var n=this;return Promise.race([e,new Promise(function(e,r){n.config.windowRef.setTimeout(function(){return r(new y({timeoutMilliSeconds:t}))},t)})])},e.prototype.getNextCallId=function(){for(var e=null;!e||this.callbacks[e];)e="cb"+Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,8);return e},e.prototype.sendMessage=function(e,t,n){return this.internalEventCallback("onSend",n,e,t),this.transport.send({targetWindow:e,targetOrigin:t},n)},e.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},e.prototype.unpackParams=function(e){return this.isArray(e)?e:void 0===e?[]:[e]},e.prototype.handleRequest=function(e,t,n){return o(this,void 0,void 0,function(){var r,i,o,s,u,h,d=this;return a(this,function(a){return r=e.id,i=e.method,o=this.unpackParams(e.params),s=n&&"null"!==n?n:null,u=function(e,n){var i,o,a,u=p(e);return d.sendMessage(t,s,{id:r,isErrorInstance:u,error:u?(i=e,o=n,a=function(e){var t=c(e);return o&&(t.name=o),t},a(i instanceof l?i:new l(i))):e})},h=function(){if(d.resultCache.hasCachedResult(r))return d.resultCache.getCachedResult(r);var a=new Promise(function(r){r(d.registeredProcedures[i].apply({requestMessageBody:e,messageSource:t,messageOrigin:n},o))});return d.resultCache.setCachedResult(r,a),a},this.registeredProcedures[i]?h().then(function(e){return d.sendMessage(t,s,{id:r,result:e}).catch(function(e){return u(e,g.name)})},function(e){return u(e,f.name)}):u(new m({procedureName:i})),[2]})})},e.prototype.handleResponse=function(e){var t,n=this.callbacks[e.id];if(n)if(delete this.callbacks[e.id],"isErrorInstance"in e){var r=e.isErrorInstance?(t=e.error,new(v[t.name]||l)(t)):e.error;n.reject(r)}else"result"in e&&n.resolve(e.result);else this.internalEventCallback("onUnexpectedResponse",e)},e.VERSION="d2b5d04",e}()}])});
//# sourceMappingURL=mini-iframe-rpc.min.js.map